@model LicenseEditViewModel
@{
    ViewData["Title"] = Model.Title;
    Layout = "_EditBase";
}

<div class="col-12">
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading license information...</p>
    </div>
</div>

@section Scripts {
    <script>
        const licenseId = @Model.LicenseId;

        $(function () {
            loadLicense();
        });

        async function loadLicense() {
            try {
                const response = await fetch(`/api/licenses/${licenseId}`);

                if (!response.ok) {
                    throw new Error('Failed to load license');
                }

                const license = await response.json();
                renderEditForm(license);
            } catch (error) {
                console.error('Error loading license:', error);
                showError('Failed to load license. Please try again.');
            }
        }

        function renderEditForm(license) {
            const issuedDate = new Date(license.issuedAt).toLocaleString('pl-PL');
            const expiresDate = new Date(license.expiresAt);
            const expiresDateValue = expiresDate.toISOString().slice(0, 16);

            const content = `
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="dx-icon-edit"></i> Edit License</h5>
                        </div>
                        <div class="card-body">
                            <form id="editForm">
                                <input type="hidden" id="licenseId" value="${license.id}" />
                                
                                <div class="mb-3">
                                    <label for="licenseKey" class="form-label">License Key</label>
                                    <input type="text" class="form-control" id="licenseKey" value="${license.licenseKey}" readonly />
                                    <small class="text-muted">License key cannot be changed</small>
                                </div>

                                <div class="mb-3">
                                    <label for="applicationName" class="form-label">Application</label>
                                    <input type="text" class="form-control" id="applicationName" value="${license.applicationName}" readonly />
                                    <small class="text-muted">Application cannot be changed</small>
                                </div>

                                <div class="mb-3">
                                    <label for="maxDevices" class="form-label">Max Devices <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="maxDevices" value="${license.maxDevices}" min="1" max="10" required />
                                    <small class="text-muted">Currently registered: ${license.registeredDevices} devices</small>
                                </div>

                                <div class="mb-3">
                                    <label for="expiresAt" class="form-label">Expires At <span class="text-danger">*</span></label>
                                    <input type="datetime-local" class="form-control" id="expiresAt" value="${expiresDateValue}" required />
                                </div>

                                <div class="mb-3">
                                    <label for="status" class="form-label">Status <span class="text-danger">*</span></label>
                                    <select class="form-select" id="status" required>
    <option value="1" ${license.status === 1 ? 'selected' : ''}>Active</option>
    <option value="2" ${license.status === 2 ? 'selected' : ''}>Expired</option>
    <option value="3" ${license.status === 3 ? 'selected' : ''}>Revoked</option>
    <option value="4" ${license.status === 4 ? 'selected' : ''}>Pending</option>
    <option value="5" ${license.status === 5 ? 'selected' : ''}>Suspended</option>
    <option value="6" ${license.status === 6 ? 'selected' : ''}>Inactive</option>
</select>
                                </div>

                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-primary" onclick="saveLicense()">
                                        <i class="dx-icon-save"></i> Save Changes
                                    </button>
                                    <a href="/Licenses/Details/${license.id}" class="btn btn-secondary">
                                        <i class="dx-icon-close"></i> Cancel
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="dx-icon-info"></i> Information</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">
                                <i class="dx-icon-clock"></i> Issued: ${issuedDate}
                            </p>
                            <p class="text-muted">
                                <i class="dx-icon-runner"></i> Registered Devices: ${license.registeredDevices}
                            </p>
                            <hr />
                            <h6>Required Fields</h6>
                            <ul class="small">
                                <li>Max Devices</li>
                                <li>Expires At</li>
                                <li>Status</li>
                            </ul>
                            <hr />
                            <div class="alert alert-warning small mb-0">
                                <i class="dx-icon-warning"></i> Reducing max devices below currently registered devices may cause validation failures.
                            </div>
                        </div>
                    </div>
                </div>
            `;

            $('.row').html(content);
        }

        async function saveLicense() {
            const data = {
                id: parseInt($('#licenseId').val()),
                maxDevices: parseInt($('#maxDevices').val()),
                expiresAt: $('#expiresAt').val(),
                status: parseInt($('#status').val())
            };

            if (!data.maxDevices || !data.expiresAt) {
                DevExpress.ui.notify("Please fill all required fields", "error", 3000);
                return;
            }

            if (data.maxDevices < 1 || data.maxDevices > 10) {
                DevExpress.ui.notify("Max devices must be between 1 and 10", "error", 3000);
                return;
            }

            try {
                const response = await fetch(`/api/licenses/${data.id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error('Failed to update license');
                }

                DevExpress.ui.notify("License updated successfully", "success", 2000);
                setTimeout(() => window.location.href = `/Licenses/Details/${data.id}`, 2000);
            } catch (error) {
                console.error('Error saving license:', error);
                DevExpress.ui.notify("Failed to update license", "error", 3000);
            }
        }

        function showError(message) {
            $('.row').html(`
                <div class="col-12">
                    <div class="alert alert-danger">
                        <i class="dx-icon-warning"></i> ${message}
                    </div>
                </div>
            `);
        }
    </script>
}