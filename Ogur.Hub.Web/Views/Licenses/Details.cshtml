// File: Hub.Web/Views/Licenses/Details.cshtml
// Project: Hub.Web
// Namespace: Hub.Web.Views.Licenses

@model LicenseDetailsViewModel
@{
    ViewData["Title"] = Model.Title;
    Layout = "_DetailsBase";
}

<div class="col-12">
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading license details...</p>
    </div>
</div>

@section Scripts {
    <script>
        const licenseId = @Model.LicenseId;

        $(function() {
            loadLicenseDetails();
        });

        async function loadLicenseDetails() {
            try {
                const response = await fetch(`/api/licenses/${licenseId}`);
                
                if (!response.ok) {
                    throw new Error('Failed to load license details');
                }

                const license = await response.json();
                renderLicenseDetails(license);
            } catch (error) {
                console.error('Error loading license:', error);
                showError('Failed to load license details. Please try again.');
            }
        }

        function renderLicenseDetails(license) {
            const statusBadge = getStatusBadge(license.status);

            const content = `
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="dx-icon-key"></i> License Information</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-borderless">
                                <tbody>
                                    <tr>
                                        <th width="40%">License Key:</th>
                                        <td><code>${license.licenseKey}</code></td>
                                    </tr>
                                    <tr>
                                        <th>Application:</th>
                                        <td>${license.applicationName}</td>
                                    </tr>
                                    <tr>
                                        <th>Status:</th>
                                        <td>${statusBadge}</td>
                                    </tr>
                                    <tr>
                                        <th>Issued:</th>
                                        <td>${new Date(license.issuedAt).toLocaleString('pl-PL')}</td>
                                    </tr>
                                    <tr>
                                        <th>Expires:</th>
                                        <td>${new Date(license.expiresAt).toLocaleString('pl-PL')}</td>
                                    </tr>
                                    <tr>
                                        <th>Max Devices:</th>
                                        <td>${license.maxDevices}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="dx-icon-runner"></i> Devices</h5>
                            <span class="badge bg-primary">${license.registeredDevices} / ${license.maxDevices}</span>
                        </div>
                        <div class="card-body">
                            <p class="mb-2"><strong>Registered:</strong> ${license.registeredDevices}</p>
                            <p class="mb-0"><strong>Online:</strong> ${license.onlineDevices || 0}</p>
                            <a href="/Devices/Index?licenseId=${license.id}" class="btn btn-sm btn-outline-primary mt-2">
                                View All Devices
                            </a>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="dx-icon-chart"></i> Statistics</h5>
                        </div>
                        <div class="card-body">
                            <p class="mb-2"><strong>Total Validations:</strong> ${license.validationCount || 0}</p>
                            ${license.lastValidationAt ? 
                                `<p class="mb-0"><strong>Last Validation:</strong> ${new Date(license.lastValidationAt).toLocaleString('pl-PL')}</p>` :
                                '<p class="mb-0"><strong>Last Validation:</strong> Never</p>'
                            }
                        </div>
                    </div>
                </div>
            `;

            $('.row').html(content);

            // Update additional actions if needed
            if (license.status === 1) {
                updateAdditionalActions(license.id);
            }
        }

        function updateAdditionalActions(licenseId) {
            const actionsHtml = `
                <button type="button" class="btn btn-danger" onclick="revokeLicense(${licenseId})">
                    <i class="dx-icon-clear"></i> Revoke License
                </button>
            `;
            
            // Find the actions container and update it if exists
            const actionsContainer = $('[data-actions-container]');
            if (actionsContainer.length) {
                actionsContainer.html(actionsHtml);
            }
        }

        function getStatusBadge(status) {
            const statusMap = {
                1: { class: 'bg-success', text: 'Active' },
                2: { class: 'bg-danger', text: 'Expired' },
                3: { class: 'bg-dark', text: 'Revoked' }
            };
            const s = statusMap[status] || { class: 'bg-secondary', text: 'Unknown' };
            return `<span class="badge ${s.class}">${s.text}</span>`;
        }

        async function revokeLicense(licenseId) {
            if (!confirm('Are you sure you want to revoke this license? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/licenses/${licenseId}/revoke`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    throw new Error('Failed to revoke license');
                }

                DevExpress.ui.notify("License revoked successfully", "success", 2000);
                setTimeout(() => window.location.reload(), 2000);
            } catch (error) {
                console.error('Error revoking license:', error);
                DevExpress.ui.notify("Failed to revoke license", "error", 3000);
            }
        }

        function showError(message) {
            $('.row').html(`
                <div class="col-12">
                    <div class="alert alert-danger">
                        <i class="dx-icon-warning"></i> ${message}
                    </div>
                </div>
            `);
        }
    </script>
}