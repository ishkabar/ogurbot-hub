@model UsersViewModel
@{
ViewData["Title"] = Model.Title;
}

<!-- Page Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2>@Model.Title</h2>
                <p class="text-muted">@Model.Description</p>
            </div>
            <div>
                <button type="button" class="btn btn-primary" onclick="showCreatePopup()">
                    <i class="dx-icon-plus"></i> New User
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stat-card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2">Total Users</h6>
                        <h2 class="card-title mb-0">@Model.Users.Count</h2>
                    </div>
                    <div class="stat-icon">
                        <i class="dx-icon-user" style="font-size: 48px;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stat-card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2">Active Users</h6>
                        <h2 class="card-title mb-0">@Model.Users.Count(u => u.IsActive)</h2>
                    </div>
                    <div class="stat-icon">
                        <i class="dx-icon-check" style="font-size: 48px;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stat-card bg-warning text-dark">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2">Administrators</h6>
                        <h2 class="card-title mb-0">@Model.Users.Count(u => u.IsAdmin)</h2>
                    </div>
                    <div class="stat-icon">
                        <i class="dx-icon-favorites" style="font-size: 48px;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stat-card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2">Total Licenses</h6>
                        <h2 class="card-title mb-0">@Model.Users.Sum(u => u.LicensesCount)</h2>
                    </div>
                    <div class="stat-icon">
                        <i class="dx-icon-key" style="font-size: 48px;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Users Grid -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">All Users</h5>
            </div>
            <div class="card-body">
                <div id="usersGrid"></div>
            </div>
        </div>
    </div>
</div>

<!-- Create Popup -->
<div id="createPopup"></div>

@section Scripts {
<script>
    let createPopup;
    let usersGrid;
    let pendingCreateData = null;
    const users = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Users));

    $(function() {
        console.log("Users loaded:", users.length);

        createPopup = $("#createPopup").dxPopup({
            width: 600,
            height: "auto",
            maxHeight: "90vh",
            showTitle: true,
            title: "New User",
            showCloseButton: true,
            contentTemplate: function() {
                return $("<div>").attr("id", "createContent").addClass("p-3");
            },
            onShown: function() {
                if (pendingCreateData) {
                    renderCreate();
                    pendingCreateData = null;
                }
            }
        }).dxPopup("instance");

        setTimeout(function() {
            usersGrid = $("#usersGrid").dxDataGrid({
                dataSource: users,
                showBorders: true,
                showRowLines: true,
                rowAlternationEnabled: true,
                hoverStateEnabled: true,
                columnAutoWidth: true,
                noDataText: "No users found",
                filterRow: { visible: true },
                headerFilter: { visible: true },
                searchPanel: { visible: true, width: 240, placeholder: "Search users..." },
                paging: { pageSize: 15 },
                pager: { visible: true, showPageSizeSelector: true, allowedPageSizes: [10, 15, 25, 50] },
                export: { enabled: true, fileName: "users" },
                columns: [
                    { dataField: "Username", caption: "Username", width: 180 },
                    { dataField: "Email", caption: "Email", width: 220 },
                    {
                        dataField: "IsActive",
                        caption: "Status",
                        width: 110,
                        alignment: "center",
                        cellTemplate: function(container, options) {
                            const badgeClass = options.value ? "bg-success" : "bg-secondary";
                            const text = options.value ? "Active" : "Inactive";
                            $("<span>")
                                .addClass("badge " + badgeClass)
                                .text(text)
                                .appendTo(container);
                        }
                    },
                    {
                        dataField: "IsAdmin",
                        caption: "Role",
                        width: 110,
                        alignment: "center",
                        cellTemplate: function(container, options) {
                            const badgeClass = options.value ? "bg-warning" : "bg-secondary";
                            const text = options.value ? "Admin" : "User";
                            $("<span>")
                                .addClass("badge " + badgeClass)
                                .text(text)
                                .appendTo(container);
                        }
                    },
                    { dataField: "LicensesCount", caption: "Licenses", width: 100, alignment: "center" },
                    { dataField: "CreatedAt", caption: "Created", dataType: "date", format: "dd/MM/yyyy", width: 110 },
                    { dataField: "LastLoginAt", caption: "Last Login", dataType: "date", format: "dd/MM/yyyy", width: 110 },
                    {
                        type: "buttons",
                        width: 120,
                        buttons: [
                            {
                                hint: "View Details",
                                icon: "info",
                                onClick: function(e) {
                                    showUserDetailsPopup(e.row.data.Id);
                                }
                            },
                            {
                                hint: "Edit",
                                icon: "edit",
                                onClick: function(e) {
                                    showUserEditPopup(e.row.data.Id);
                                }
                            }
                        ]
                    }
                ],
                onContentReady: function() {
                    console.log("Grid rendered with " + users.length + " items");
                }
            }).dxDataGrid("instance");
        }, 200);
    });

    function showCreatePopup() {
        pendingCreateData = {};
        createPopup.show();
    }

    function renderCreate() {
        var content = '<form id="createForm">' +
            '<div class="row">' +
            '<div class="col-md-6">' +
            '<div class="mb-3">' +
            '<label class="form-label">Username *</label>' +
            '<input type="text" class="form-control" id="userName" placeholder="Enter username" required>' +
            '<div class="form-text">3-50 characters, letters, numbers, dots, underscores, hyphens</div>' +
            '</div>' +
            '</div>' +
            '<div class="col-md-6">' +
            '<div class="mb-3">' +
            '<label class="form-label">Email *</label>' +
            '<input type="email" class="form-control" id="userEmail" placeholder="user@example.com" required>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '<div class="row">' +
            '<div class="col-md-6">' +
            '<div class="mb-3">' +
            '<label class="form-label">Password *</label>' +
            '<input type="password" class="form-control" id="userPassword" placeholder="Enter password" required>' +
            '<div class="form-text">Minimum 6 characters</div>' +
            '</div>' +
            '</div>' +
            '<div class="col-md-6">' +
            '<div class="mb-3">' +
            '<label class="form-label">Confirm Password *</label>' +
            '<input type="password" class="form-control" id="userConfirmPassword" placeholder="Confirm password" required>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '<div class="row">' +
            '<div class="col-md-6">' +
            '<div class="mb-3">' +
            '<div class="form-check">' +
            '<input class="form-check-input" type="checkbox" id="userIsActive" checked>' +
            '<label class="form-check-label" for="userIsActive">Active</label>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '<div class="col-md-6">' +
            '<div class="mb-3">' +
            '<div class="form-check">' +
            '<input class="form-check-input" type="checkbox" id="userIsAdmin">' +
            '<label class="form-check-label" for="userIsAdmin">Administrator</label>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '<hr>' +
            '<div class="d-flex gap-2 mt-3">' +
            '<button type="submit" class="btn btn-primary">' +
            '<i class="dx-icon-plus"></i> Create User' +
            '</button>' +
            '<button type="button" class="btn btn-secondary" onclick="createPopup.hide()">' +
            'Cancel' +
            '</button>' +
            '</div>' +
            '</form>';

        $("#createContent").html(content);

        // Form validation and submission
        $("#createForm").on("submit", function(e) {
            e.preventDefault();

            const username = $("#userName").val().trim();
            const email = $("#userEmail").val().trim();
            const password = $("#userPassword").val();
            const confirmPassword = $("#userConfirmPassword").val();
            const isActive = $("#userIsActive").is(":checked");
            const isAdmin = $("#userIsAdmin").is(":checked");

            if (!username || !email || !password || !confirmPassword) {
                DevExpress.ui.notify("Please fill in all required fields", "error", 2000);
                return;
            }

            if (username.length < 3 || username.length > 50) {
                DevExpress.ui.notify("Username must be 3-50 characters", "error", 2000);
                return;
            }

            if (!/^[a-zA-Z0-9._-]+$/.test(username)) {
                DevExpress.ui.notify("Username can only contain letters, numbers, dots, underscores and hyphens", "error", 2000);
                return;
            }

            if (password.length < 6) {
                DevExpress.ui.notify("Password must be at least 6 characters", "error", 2000);
                return;
            }

            if (password !== confirmPassword) {
                DevExpress.ui.notify("Passwords do not match", "error", 2000);
                return;
            }

            const emailRegex = /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/;
            if (!emailRegex.test(email)) {
                DevExpress.ui.notify("Invalid email format", "error", 2000);
                return;
            }

            submitCreate({
                username: username,
                email: email,
                password: password,
                isActive: isActive,
                isAdmin: isAdmin
            });
        });
    }

    function submitCreate(data) {
        $.ajax({
            url: '@Url.Action("Create", "Users")',
            method: 'POST',
            contentType: 'application/json',
            headers: {
                'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
            },
            data: JSON.stringify(data),
            success: function(result) {
                if (result.success) {
                    DevExpress.ui.notify("User created successfully!", "success", 2000);
                    createPopup.hide();
                    location.reload();
                } else {
                    DevExpress.ui.notify(result.message || "Failed to create user", "error", 3000);
                }
            },
            error: function(xhr) {
                const message = xhr.responseJSON?.message || "An error occurred while creating the user";
                DevExpress.ui.notify(message, "error", 3000);
            }
        });
    }
</script>
}
