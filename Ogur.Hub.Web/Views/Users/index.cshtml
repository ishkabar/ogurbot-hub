@* File: Hub.Web/Views/Users/Index.cshtml *@
@using Ogur.Hub.Web.Services
@model UsersViewModel
@{
ViewData["Title"] = Model.Title;
}

<!-- Page Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2>@Model.Title</h2>
                <p class="text-muted">@Model.Description</p>
            </div>
            @if (Model.Users.Count > 0)
            {
            <div>
                <a asp-action="Create" class="btn btn-primary">
                    <i class="dx-icon-plus"></i> New User
                </a>
            </div>
            }
        </div>
    </div>
</div>

@if (TempData["ErrorMessage"] != null)
{
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    @TempData["ErrorMessage"]
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
}

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stat-card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2">Total Users</h6>
                        <h2 class="card-title mb-0">@Model.Users.Count</h2>
                    </div>
                    <div class="stat-icon">
                        <i class="dx-icon-user" style="font-size: 48px;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stat-card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2">Active Users</h6>
                        <h2 class="card-title mb-0">@Model.Users.Count(u => u.IsActive)</h2>
                    </div>
                    <div class="stat-icon">
                        <i class="dx-icon-check" style="font-size: 48px;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stat-card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2">Administrators</h6>
                        <h2 class="card-title mb-0">@Model.Users.Count(u => u.IsAdmin)</h2>
                    </div>
                    <div class="stat-icon">
                        <i class="dx-icon-preferences" style="font-size: 48px;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stat-card bg-warning text-dark">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2">Total Licenses</h6>
                        <h2 class="card-title mb-0">@Model.Users.Sum(u => u.LicensesCount)</h2>
                    </div>
                    <div class="stat-icon">
                        <i class="dx-icon-key" style="font-size: 48px;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Users Grid -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">All Users</h5>
            </div>
            <div class="card-body">
                <div id="usersGrid"></div>
            </div>
        </div>
    </div>
</div>

<!-- Details Popup -->
<div id="detailsPopup"></div>

<!-- Edit Popup -->
<div id="editPopup"></div>

@section Scripts {
<script>
    let detailsPopup;
    let editPopup;
    let usersGrid;
    let pendingDetailsData = null;
    let pendingEditData = null;
    const users = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Users));

    $(function() {
        console.log("Users loaded:", users.length);

        detailsPopup = $("#detailsPopup").dxPopup({
            width: 900,
            height: "auto",
            maxHeight: "90vh",
            showTitle: true,
            title: "User Details",
            showCloseButton: true,
            contentTemplate: function() {
                return $("<div>").attr("id", "detailsContent").addClass("p-3");
            },
            onShown: function() {
                if (pendingDetailsData) {
                    renderDetails(pendingDetailsData);
                    pendingDetailsData = null;
                }
            }
        }).dxPopup("instance");

        editPopup = $("#editPopup").dxPopup({
            width: 700,
            height: "auto",
            maxHeight: "90vh",
            showTitle: true,
            title: "Edit User",
            showCloseButton: true,
            contentTemplate: function() {
                return $("<div>").attr("id", "editContent").addClass("p-3");
            },
            onShown: function() {
                if (pendingEditData) {
                    renderEdit(pendingEditData);
                    pendingEditData = null;
                }
            }
        }).dxPopup("instance");

        setTimeout(function() {
            usersGrid = $("#usersGrid").dxDataGrid({
                dataSource: users,
                showBorders: true,
                showRowLines: true,
                rowAlternationEnabled: true,
                hoverStateEnabled: true,
                columnAutoWidth: true,
                noDataText: "No users found",
                filterRow: { visible: true },
                headerFilter: { visible: true },
                searchPanel: { visible: true, width: 240, placeholder: "Search users..." },
                paging: { pageSize: 15 },
                pager: { visible: true, showPageSizeSelector: true, allowedPageSizes: [10, 15, 25, 50] },
                export: { enabled: true, fileName: "users" },
                columns: [
                    { dataField: "Username", caption: "Username", width: 180 },
                    { dataField: "Email", caption: "Email", width: 250 },
                    {
                        dataField: "IsActive",
                        caption: "Status",
                        width: 110,
                        alignment: "center",
                        cellTemplate: function (container, options) {
                            const badgeClass = options.value ? "badge bg-success" : "badge bg-secondary";
                            const text = options.value ? "Active" : "Inactive";
                            $("<span>").addClass(badgeClass).text(text).appendTo(container);
                        }
                    },
                    {
                        dataField: "IsAdmin",
                        caption: "Role",
                        width: 110,
                        alignment: "center",
                        cellTemplate: function (container, options) {
                            const badgeClass = options.value ? "badge bg-info" : "badge bg-secondary";
                            const text = options.value ? "Admin" : "User";
                            $("<span>").addClass(badgeClass).text(text).appendTo(container);
                        }
                    },
                    {
                        dataField: "LicensesCount",
                        caption: "Licenses",
                        width: 100,
                        alignment: "center"
                    },
                    { dataField: "CreatedAt", caption: "Created", dataType: "date", format: "dd/MM/yyyy", width: 110 },
                    {
                        dataField: "LastLoginAt",
                        caption: "Last Login",
                        dataType: "datetime",
                        format: "dd/MM/yyyy HH:mm",
                        width: 150,
                        cellTemplate: function(container, options) {
                            const text = options.value ? new Date(options.value).toLocaleString('pl-PL') : 'Never';
                            $("<span>").text(text).appendTo(container);
                        }
                    },
                    {
                        type: "buttons",
                        width: 120,
                        buttons: [
                            {
                                hint: "View Details",
                                icon: "info",
                                onClick: function (e) {
                                    showDetails(e.row.data);
                                }
                            },
                            {
                                hint: "Edit",
                                icon: "edit",
                                onClick: function (e) {
                                    showEdit(e.row.data);
                                }
                            }
                        ]
                    }
                ],
                onContentReady: function() {
                    console.log("Grid rendered with " + users.length + " items");
                }
            }).dxDataGrid("instance");
        }, 200);
    });

    function showDetails(user) {
        pendingDetailsData = user;
        detailsPopup.option("title", "User Details: " + user.Username);
        detailsPopup.show();
    }

    function renderDetails(user) {
        const createdDate = new Date(user.CreatedAt).toLocaleString('pl-PL', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });

        const lastLoginDate = user.LastLoginAt ? new Date(user.LastLoginAt).toLocaleString('pl-PL', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        }) : 'Never';

        const content = `
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="mb-3"><i class="dx-icon-user"></i> User Information</h6>
                        <table class="table table-sm table-borderless">
                            <tr><th width="40%">Username:</th><td>${user.Username}</td></tr>
                            <tr><th>Email:</th><td>${user.Email}</td></tr>
                            <tr><th>Status:</th><td><span class="badge bg-${user.IsActive ? 'success' : 'secondary'}">${user.IsActive ? 'Active' : 'Inactive'}</span></td></tr>
                            <tr><th>Role:</th><td><span class="badge bg-${user.IsAdmin ? 'info' : 'secondary'}">${user.IsAdmin ? 'Administrator' : 'User'}</span></td></tr>
                            <tr><th>Created:</th><td>${createdDate}</td></tr>
                            <tr><th>Last Login:</th><td>${lastLoginDate}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="mb-3"><i class="dx-icon-key"></i> Licenses</h6>
                        <p><strong>Total Licenses:</strong> ${user.LicensesCount}</p>
                        <a href="/Licenses/Index?userId=${user.Id}" class="btn btn-sm btn-outline-primary">
                            View User Licenses
                        </a>
                        <hr>
                        <button class="btn btn-primary btn-sm" onclick="closeDetailsAndEdit(${user.Id})">
                            <i class="dx-icon-edit"></i> Edit User
                        </button>
                    </div>
                </div>
            `;

        $("#detailsContent").html(content);
    }

    function showEdit(user) {
        pendingEditData = user;
        editPopup.option("title", "Edit User: " + user.Username);
        editPopup.show();
    }

    function renderEdit(user) {
        const content = `
                <form id="editForm">
                    <input type="hidden" id="editUserId" value="${user.Id}" />
                    
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-control" value="${user.Username}" readonly />
                        <small class="text-muted">Username cannot be changed</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Email <span class="text-danger">*</span></label>
                        <input type="email" class="form-control" id="editEmail" value="${user.Email}" required />
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="editIsActive" ${user.IsActive ? 'checked' : ''} />
                            <label class="form-check-label">Active</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="editIsAdmin" ${user.IsAdmin ? 'checked' : ''} />
                            <label class="form-check-label">Administrator</label>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-primary" onclick="saveUser()">
                            <i class="dx-icon-save"></i> Save Changes
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="editPopup.hide()">
                            <i class="dx-icon-close"></i> Cancel
                        </button>
                    </div>
                </form>
            `;

        $("#editContent").html(content);
    }

    function closeDetailsAndEdit(userId) {
        detailsPopup.hide();
        const user = users.find(u => u.Id === userId);
        if (user) {
            showEdit(user);
        }
    }

    async function saveUser() {
        const data = {
            email: $('#editEmail').val(),
            isActive: $('#editIsActive').is(':checked'),
            isAdmin: $('#editIsAdmin').is(':checked')
        };

        if (!data.email) {
            DevExpress.ui.notify("Please fill all required fields", "error", 3000);
            return;
        }

        const userId = parseInt($('#editUserId').val());

        try {
            const response = await fetch(`/api/users/${userId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to update user');
            }

            DevExpress.ui.notify("User updated successfully", "success", 2000);
            editPopup.hide();
            setTimeout(function() {
                window.location.reload();
            }, 2000);
        } catch (error) {
            console.error('Error updating user:', error);
            DevExpress.ui.notify(error.message, "error", 3000);
        }
    }
</script>
}