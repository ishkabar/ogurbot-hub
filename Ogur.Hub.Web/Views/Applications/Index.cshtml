@model ApplicationsViewModel
@{
    ViewData["Title"] = Model.Title;
}

<!-- Page Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2>@Model.Title</h2>
                <p class="text-muted">@Model.Description</p>
            </div>
            <div>
                <button type="button" class="btn btn-primary" onclick="showCreatePopup()">
                    <i class="dx-icon-plus"></i> New Application
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stat-card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2">Total Applications</h6>
                        <h2 class="card-title mb-0">@Model.Applications.Count</h2>
                    </div>
                    <div class="stat-icon">
                        <i class="dx-icon-box" style="font-size: 48px;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stat-card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2">Active Applications</h6>
                        <h2 class="card-title mb-0">@Model.Applications.Count(a => a.IsActive)</h2>
                    </div>
                    <div class="stat-icon">
                        <i class="dx-icon-check" style="font-size: 48px;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stat-card bg-warning text-dark">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2">Inactive Applications</h6>
                        <h2 class="card-title mb-0">@Model.Applications.Count(a => !a.IsActive)</h2>
                    </div>
                    <div class="stat-icon">
                        <i class="dx-icon-close" style="font-size: 48px;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stat-card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2">Latest Version</h6>
                        <h2 class="card-title mb-0" style="font-size: 1.2rem;">@(Model.Applications.Any() ? Model.Applications.OrderBy(a => a.CreatedAt).Last().CurrentVersion : "N/A")</h2>
                    </div>
                    <div class="stat-icon">
                        <i class="dx-icon-tags" style="font-size: 48px;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Applications Grid -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">All Applications</h5>
            </div>
            <div class="card-body">
                <div id="applicationsGrid"></div>
            </div>
        </div>
    </div>
</div>

<!-- Create Popup -->
<div id="createPopup"></div>

@section Scripts {
<script>
    let createPopup;
    let applicationsGrid;
    let pendingCreateData = null;
    const applications = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Applications));

    $(function() {
        console.log("Applications loaded:", applications.length);

        createPopup = $("#createPopup").dxPopup({
            width: 600,
            height: "auto",
            maxHeight: "90vh",
            showTitle: true,
            title: "New Application",
            showCloseButton: true,
            contentTemplate: function() {
                return $("<div>").attr("id", "createContent").addClass("p-3");
            },
            onShown: function() {
                if (pendingCreateData) {
                    renderCreate();
                    pendingCreateData = null;
                }
            }
        }).dxPopup("instance");

        setTimeout(function() {
            applicationsGrid = $("#applicationsGrid").dxDataGrid({
                dataSource: applications,
                showBorders: true,
                showRowLines: true,
                rowAlternationEnabled: true,
                hoverStateEnabled: true,
                columnAutoWidth: true,
                noDataText: "No applications found",
                filterRow: { visible: true },
                headerFilter: { visible: true },
                searchPanel: { visible: true, width: 240, placeholder: "Search applications..." },
                paging: { pageSize: 15 },
                pager: { visible: true, showPageSizeSelector: true, allowedPageSizes: [10, 15, 25, 50] },
                export: { enabled: true, fileName: "applications" },
                columns: [
                    { dataField: "Name", caption: "Name", width: 180 },
                    { dataField: "DisplayName", caption: "Display Name", width: 220 },
                    { dataField: "Description", caption: "Description", width: 300 },
                    { dataField: "CurrentVersion", caption: "Version", width: 120 },
                    {
                        dataField: "IsActive",
                        caption: "Status",
                        width: 110,
                        alignment: "center",
                        cellTemplate: function(container, options) {
                            const badgeClass = options.value ? "bg-success" : "bg-secondary";
                            const text = options.value ? "Active" : "Inactive";
                            $("<span>")
                                .addClass("badge " + badgeClass)
                                .text(text)
                                .appendTo(container);
                        }
                    },
                    { dataField: "CreatedAt", caption: "Created", dataType: "date", format: "dd/MM/yyyy", width: 110 },
                    {
                        type: "buttons",
                        width: 120,
                        buttons: [
                            {
                                hint: "View Details",
                                icon: "info",
                                onClick: function(e) {
                                    window.location.href = '@Url.Action("Details", "Applications")/' + e.row.data.Id;
                                }
                            },
                            {
                                hint: "Edit",
                                icon: "edit",
                                onClick: function(e) {
                                    window.location.href = '@Url.Action("Edit", "Applications")/' + e.row.data.Id;
                                }
                            }
                        ]
                    }
                ],
                onContentReady: function() {
                    console.log("Grid rendered with " + applications.length + " items");
                }
            }).dxDataGrid("instance");
        }, 200);
    });

    function showCreatePopup() {
        pendingCreateData = {};
        createPopup.show();
    }

    function renderCreate() {
        const content = `
            <form id="createForm">
                <div class="row">
                    <div class="col-12">
                        <div class="mb-3">
                            <label class="form-label">Name *</label>
                            <input type="text" class="form-control" id="appName" placeholder="e.g., MyApp" required>
                            <div class="form-text">Application internal name (letters, numbers, underscore, hyphen only)</div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="mb-3">
                            <label class="form-label">Display Name *</label>
                            <input type="text" class="form-control" id="appDisplayName" placeholder="e.g., My Application" required>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="appDescription" rows="3" placeholder="Application description..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Current Version *</label>
                            <input type="text" class="form-control" id="appVersion" value="1.0.0" required>
                            <div class="form-text">Semantic versioning (e.g., 1.0.0)</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="appIsActive" checked>
                                <label class="form-check-label" for="appIsActive">Active</label>
                            </div>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="d-flex gap-2 mt-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="dx-icon-plus"></i> Create Application
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="createPopup.hide()">
                        Cancel
                    </button>
                </div>
            </form>
        `;

        $("#createContent").html(content);

        // Form validation and submission
        $("#createForm").on("submit", function(e) {
            e.preventDefault();
            
            const name = $("#appName").val().trim();
            const displayName = $("#appDisplayName").val().trim();
            const description = $("#appDescription").val().trim();
            const version = $("#appVersion").val().trim();
            const isActive = $("#appIsActive").is(":checked");

            if (!name || !displayName || !version) {
                DevExpress.ui.notify("Please fill in all required fields", "error", 2000);
                return;
            }

            if (!/^[a-zA-Z0-9_-]+$/.test(name)) {
                DevExpress.ui.notify("Name can only contain letters, numbers, underscores and hyphens", "error", 2000);
                return;
            }

            if (!/^\d+\.\d+\.\d+.*$/.test(version)) {
                DevExpress.ui.notify("Version must follow semantic versioning (e.g., 1.0.0)", "error", 2000);
                return;
            }

            submitCreate({
                name: name,
                displayName: displayName,
                description: description || null,
                currentVersion: version,
                isActive: isActive
            });
        });
    }

    function submitCreate(data) {
        $.ajax({
            url: '@Url.Action("Create", "Applications")',
            method: 'POST',
            contentType: 'application/json',
            headers: {
                'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
            },
            data: JSON.stringify(data),
            success: function(result) {
                if (result.success) {
                    DevExpress.ui.notify("Application created successfully!", "success", 2000);
                    createPopup.hide();
                    location.reload();
                } else {
                    DevExpress.ui.notify(result.message || "Failed to create application", "error", 3000);
                }
            },
            error: function(xhr) {
                const message = xhr.responseJSON?.message || "An error occurred while creating the application";
                DevExpress.ui.notify(message, "error", 3000);
            }
        });
    }
</script>
}
