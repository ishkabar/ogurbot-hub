// File: Hub.Web/Views/Applications/Edit.cshtml
// Project: Hub.Web
// Namespace: Ogur.Hub.Web.Views.Applications

@model ApplicationEditViewModel
@{
    ViewData["Title"] = Model.Title;
    Layout = "_EditBase";
}

<div class="col-12">
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading application information...</p>
    </div>
</div>

@section Scripts {
    <script>
        const applicationId = @Model.ApplicationId;

        $(function() {
            loadApplication();
            
            // Add ESC key handler for exit
            $(document).on('keydown', function(e) {
                if (e.key === 'Escape') {
                    window.location.href = `/Applications/Details/${applicationId}`;
                }
            });
        });

        async function loadApplication() {
            try {
                const response = await fetch(`/api/applications/${applicationId}`, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('authToken')
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load application');
                }

                const result = await response.json();
                const application = result.data || result;
                renderEditForm(application);
            } catch (error) {
                console.error('Error loading application:', error);
                showError('Failed to load application. Please try again.');
            }
        }

        function renderEditForm(app) {
            const content = `
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="dx-icon-edit"></i> Edit Application</h5>
                        </div>
                        <div class="card-body">
                            <form id="editForm">
                                <input type="hidden" id="applicationId" value="${app.id}" />
                                
                                <div class="mb-3">
                                    <label for="name" class="form-label">Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="name" value="${app.name}" required />
                                    <small class="text-muted">Internal application identifier</small>
                                </div>

                                <div class="mb-3">
                                    <label for="displayName" class="form-label">Display Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="displayName" value="${app.displayName}" required />
                                </div>

                                <div class="mb-3">
                                    <label for="description" class="form-label">Description</label>
                                    <textarea class="form-control" id="description" rows="3">${app.description || ''}</textarea>
                                </div>

                                <div class="mb-3">
                                    <label for="currentVersion" class="form-label">Current Version <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="currentVersion" value="${app.currentVersion}" required />
                                </div>

                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="isActive" ${app.isActive ? 'checked' : ''} />
                                        <label class="form-check-label" for="isActive">
                                            Application is active
                                        </label>
                                    </div>
                                </div>

                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-primary" onclick="saveApplication()">
                                        <i class="dx-icon-save"></i> Save Changes
                                    </button>
                                    <a href="/Applications/Details/${app.id}" class="btn btn-secondary">
                                        <i class="dx-icon-close"></i> Cancel
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="dx-icon-info"></i> Information</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">
                                <i class="dx-icon-clock"></i> Created: ${new Date(app.createdAt).toLocaleString('pl-PL')}
                            </p>
                            <hr />
                            <h6>Required Fields</h6>
                            <ul class="small">
                                <li>Name</li>
                                <li>Display Name</li>
                                <li>Current Version</li>
                            </ul>
                            <hr />
                            <div class="alert alert-info small mb-0">
                                <i class="dx-icon-info"></i> Press ESC to cancel editing.
                            </div>
                        </div>
                    </div>
                </div>
            `;

            $('.row').html(content);
        }

        async function saveApplication() {
            const data = {
                name: $('#name').val().trim(),
                displayName: $('#displayName').val().trim(),
                description: $('#description').val().trim(),
                currentVersion: $('#currentVersion').val().trim(),
                isActive: $('#isActive').is(':checked')
            };

            if (!data.name || !data.displayName || !data.currentVersion) {
                DevExpress.ui.notify("Please fill all required fields", "error", 3000);
                return;
            }

            try {
                const response = await fetch(`/api/applications/${applicationId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('authToken')
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error('Failed to update application');
                }

                DevExpress.ui.notify("Application updated successfully", "success", 2000);
                setTimeout(() => window.location.href = `/Applications/Details/${applicationId}`, 2000);
            } catch (error) {
                console.error('Error saving application:', error);
                DevExpress.ui.notify("Failed to update application", "error", 3000);
            }
        }

        function showError(message) {
            $('.row').html(`
                <div class="col-12">
                    <div class="alert alert-danger">
                        <i class="dx-icon-warning"></i> ${message}
                    </div>
                </div>
            `);
        }
    </script>
}