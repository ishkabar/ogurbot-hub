@model DeviceDetailsViewModel
@{
    ViewData["Title"] = Model.Title;
    Layout = "_DetailsBase";
}

<div class="col-12">
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading device details...</p>
    </div>
</div>

@section Scripts {
    <script>
        const deviceId = @Model.DeviceId;

        $(function() {
            loadDeviceDetails();
        });

        async function loadDeviceDetails() {
            try {
                const response = await fetch(`/api/devices/${deviceId}`);
                
                if (!response.ok) {
                    throw new Error('Failed to load device details');
                }

                const device = await response.json();
                renderDeviceDetails(device);
            } catch (error) {
                console.error('Error loading device:', error);
                showError('Failed to load device details. Please try again.');
            }
        }

        function renderDeviceDetails(device) {
            const statusBadge = getStatusBadge(device.status);
            const connectionBadge = device.connectionId ? '<span class="badge bg-success">Online</span>' : '<span class="badge bg-secondary">Offline</span>';

            const content = `
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="dx-icon-runner"></i> Device Information</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-borderless">
                                <tbody>
                                    <tr>
                                        <th width="40%">Device Name:</th>
                                        <td>${device.deviceName}</td>
                                    </tr>
                                    <tr>
                                        <th>HWID:</th>
                                        <td><code>${device.hwid}</code></td>
                                    </tr>
                                    <tr>
                                        <th>Status:</th>
                                        <td>${statusBadge}</td>
                                    </tr>
                                    <tr>
                                        <th>IP Address:</th>
                                        <td>${device.lastIpAddress || 'N/A'}</td>
                                    </tr>
                                    <tr>
                                        <th>Registered:</th>
                                        <td>${new Date(device.registeredAt).toLocaleString('pl-PL')}</td>
                                    </tr>
                                    <tr>
                                        <th>Last Seen:</th>
                                        <td>${new Date(device.lastSeenAt).toLocaleString('pl-PL')}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="dx-icon-info"></i> Connection</h5>
                        </div>
                        <div class="card-body">
                            <p class="mb-2"><strong>Status:</strong> ${connectionBadge}</p>
                            ${device.connectionId ? `<p class="mb-0"><strong>Connection ID:</strong> <code>${device.connectionId}</code></p>` : ''}
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="dx-icon-key"></i> License</h5>
                        </div>
                        <div class="card-body">
                            <p class="mb-2"><strong>Key:</strong> <code>${device.licenseKey}</code></p>
                            <p class="mb-0"><strong>Application:</strong> ${device.applicationName}</p>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="dx-icon-chart"></i> Statistics</h5>
                        </div>
                        <div class="card-body">
                            <p class="mb-2"><strong>Telemetry Events:</strong> ${device.telemetryCount || 0}</p>
                            <p class="mb-2"><strong>Commands Sent:</strong> ${device.commandsCount || 0}</p>
                            <p class="mb-0"><strong>Total Session Time:</strong> ${device.totalSessionMinutes || 0} minutes</p>
                        </div>
                    </div>
                </div>
            `;

            $('.row').html(content);
        }

        function getStatusBadge(status) {
            const statusMap = {
                1: { class: 'bg-success', text: 'Online' },
                2: { class: 'bg-warning', text: 'Offline' },
                3: { class: 'bg-danger', text: 'Blocked' },
                4: { class: 'bg-warning', text: 'Warning' }
            };
            const s = statusMap[status] || { class: 'bg-secondary', text: 'Unknown' };
            return `<span class="badge ${s.class}">${s.text}</span>`;
        }

        function showError(message) {
            $('.row').html(`
                <div class="col-12">
                    <div class="alert alert-danger">
                        <i class="dx-icon-warning"></i> ${message}
                    </div>
                </div>
            `);
        }
    </script>
}