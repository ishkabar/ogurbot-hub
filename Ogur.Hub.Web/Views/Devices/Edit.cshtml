// File: Hub.Web/Views/Devices/Edit.cshtml
// Project: Hub.Web
// Namespace: Hub.Web.Views.Devices

@model DeviceEditViewModel
@{
    ViewData["Title"] = Model.Title;
    Layout = "_EditBase";
}

<div class="col-12">
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading device information...</p>
    </div>
</div>

@section Scripts {
    <script>
        const deviceId = @Model.DeviceId;

        $(function() {
            loadDevice();
        });

        async function loadDevice() {
            try {
                const response = await fetch(`/api/devices/${deviceId}`);
                
                if (!response.ok) {
                    throw new Error('Failed to load device');
                }

                const device = await response.json();
                renderEditForm(device);
            } catch (error) {
                console.error('Error loading device:', error);
                showError('Failed to load device. Please try again.');
            }
        }

        function renderEditForm(device) {
            const content = `
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="dx-icon-edit"></i> Edit Device</h5>
                        </div>
                        <div class="card-body">
                            <form id="editForm">
                                <input type="hidden" id="deviceId" value="${device.id}" />
                                
                                <div class="mb-3">
                                    <label for="deviceName" class="form-label">Device Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="deviceName" value="${device.deviceName}" required />
                                </div>

                                <div class="mb-3">
                                    <label for="hwid" class="form-label">HWID</label>
                                    <input type="text" class="form-control" id="hwid" value="${device.hwid}" readonly />
                                    <small class="text-muted">Hardware ID cannot be changed</small>
                                </div>

                                <div class="mb-3">
                                    <label for="status" class="form-label">Status <span class="text-danger">*</span></label>
                                    <select class="form-select" id="status" required>
                                        <option value="1" ${device.status === 1 ? 'selected' : ''}>Online</option>
                                        <option value="2" ${device.status === 2 ? 'selected' : ''}>Offline</option>
                                        <option value="3" ${device.status === 3 ? 'selected' : ''}>Blocked</option>
                                        <option value="4" ${device.status === 4 ? 'selected' : ''}>Warning</option>
                                    </select>
                                </div>

                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-primary" onclick="saveDevice()">
                                        <i class="dx-icon-save"></i> Save Changes
                                    </button>
                                    <a href="/Devices/Details/${device.id}" class="btn btn-secondary">
                                        <i class="dx-icon-close"></i> Cancel
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="dx-icon-info"></i> Information</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">
                                <i class="dx-icon-clock"></i> Registered: ${new Date(device.registeredAt).toLocaleString('pl-PL')}
                            </p>
                            <p class="text-muted">
                                <i class="dx-icon-clock"></i> Last Seen: ${new Date(device.lastSeenAt).toLocaleString('pl-PL')}
                            </p>
                            <hr />
                            <h6>Required Fields</h6>
                            <ul class="small">
                                <li>Device Name</li>
                                <li>Status</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;

            $('.row').html(content);
        }

        async function saveDevice() {
            const data = {
                id: parseInt($('#deviceId').val()),
                deviceName: $('#deviceName').val(),
                status: parseInt($('#status').val())
            };

            if (!data.deviceName) {
                DevExpress.ui.notify("Please fill all required fields", "error", 3000);
                return;
            }

            try {
                const response = await fetch(`/api/devices/${data.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error('Failed to update device');
                }

                DevExpress.ui.notify("Device updated successfully", "success", 2000);
                setTimeout(() => window.location.href = `/Devices/Details/${data.id}`, 2000);
            } catch (error) {
                console.error('Error saving device:', error);
                DevExpress.ui.notify("Failed to update device", "error", 3000);
            }
        }

        function showError(message) {
            $('.row').html(`
                <div class="col-12">
                    <div class="alert alert-danger">
                        <i class="dx-icon-warning"></i> ${message}
                    </div>
                </div>
            `);
        }
    </script>
}