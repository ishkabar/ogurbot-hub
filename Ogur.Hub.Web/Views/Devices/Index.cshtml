@model DevicesViewModel
@{
ViewData["Title"] = Model.Title;
}

<!-- Page Header -->
<div class="row mb-4">
    <div class="col-12">
        <h2>@Model.Title</h2>
        <p class="text-muted">@Model.Description</p>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stat-card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2">Total Devices</h6>
                        <h2 class="card-title mb-0">@Model.Devices.Count</h2>
                    </div>
                    <div class="stat-icon">
                        <i class="dx-icon-runner" style="font-size: 48px;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stat-card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2">Online Devices</h6>
                        <h2 class="card-title mb-0">@Model.Devices.Count(d => d.Status == 1)</h2>
                    </div>
                    <div class="stat-icon">
                        <i class="dx-icon-check" style="font-size: 48px;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stat-card bg-warning text-dark">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2">Offline Devices</h6>
                        <h2 class="card-title mb-0">@Model.Devices.Count(d => d.Status == 2)</h2>
                    </div>
                    <div class="stat-icon">
                        <i class="dx-icon-clock" style="font-size: 48px;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stat-card bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-subtitle mb-2">Blocked Devices</h6>
                        <h2 class="card-title mb-0">@Model.Devices.Count(d => d.Status == 3)</h2>
                    </div>
                    <div class="stat-icon">
                        <i class="dx-icon-close" style="font-size: 48px;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Devices Grid -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">All Devices</h5>
            </div>
            <div class="card-body">
                <div id="devicesGrid"></div>
            </div>
        </div>
    </div>
</div>

<!-- Details Popup -->
<div id="detailsPopup"></div>

<!-- Block Popup -->
<div id="blockPopup"></div>

@section Scripts {
<script>
    let detailsPopup;
    let blockPopup;
    let devicesGrid;
    let pendingDetailsData = null;
    let pendingBlockData = null;
    const devices = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Devices));

    $(function() {
        console.log("Devices loaded:", devices.length);

        detailsPopup = $("#detailsPopup").dxPopup({
            width: 900,
            height: "auto",
            maxHeight: "90vh",
            showTitle: true,
            title: "Device Details",
            showCloseButton: true,
            contentTemplate: function() {
                return $("<div>").attr("id", "detailsContent").addClass("p-3");
            },
            onShown: function() {
                if (pendingDetailsData) {
                    renderDetails(pendingDetailsData);
                    pendingDetailsData = null;
                }
            }
        }).dxPopup("instance");

        blockPopup = $("#blockPopup").dxPopup({
            width: 500,
            height: "auto",
            showTitle: true,
            title: "Block Device",
            showCloseButton: true,
            contentTemplate: function() {
                return $("<div>").attr("id", "blockContent").addClass("p-3");
            },
            onShown: function() {
                if (pendingBlockData) {
                    renderBlock(pendingBlockData);
                    pendingBlockData = null;
                }
            }
        }).dxPopup("instance");

        setTimeout(function() {
            devicesGrid = $("#devicesGrid").dxDataGrid({
                dataSource: devices,
                showBorders: true,
                showRowLines: true,
                rowAlternationEnabled: true,
                hoverStateEnabled: true,
                columnAutoWidth: true,
                noDataText: "No devices found",
                filterRow: { visible: true },
                headerFilter: { visible: true },
                searchPanel: { visible: true, width: 240, placeholder: "Search devices..." },
                paging: { pageSize: 15 },
                pager: { visible: true, showPageSizeSelector: true, allowedPageSizes: [10, 15, 25, 50] },
                export: { enabled: true, fileName: "devices" },
                columns: [
                    { dataField: "DeviceName", caption: "Device Name", width: 200 },
                    {
                        dataField: "Hwid",
                        caption: "HWID",
                        width: 150,
                        cellTemplate: function(container, options) {
                            const displayValue = options.value ? options.value.substring(0, 16) + "..." : "N/A";
                            $("<code>").text(displayValue).appendTo(container);
                        }
                    },
                    { dataField: "LastIpAddress", caption: "IP Address", width: 130 },
                    { dataField: "RegisteredAt", caption: "Registered", dataType: "date", format: "dd/MM/yyyy", width: 110 },
                    { dataField: "LastSeenAt", caption: "Last Seen", dataType: "datetime", format: "dd/MM/yyyy HH:mm", width: 150 },
                    {
                        dataField: "Status",
                        caption: "Status",
                        width: 110,
                        alignment: "center",
                        cellTemplate: function(container, options) {
                            let badgeClass = "bg-secondary";
                            let text = "Unknown";

                            if (options.value === 1) {
                                badgeClass = "bg-success";
                                text = "Online";
                            } else if (options.value === 2) {
                                badgeClass = "bg-warning";
                                text = "Offline";
                            } else if (options.value === 3) {
                                badgeClass = "bg-danger";
                                text = "Blocked";
                            } else if (options.value === 4) {
                                badgeClass = "bg-warning";
                                text = "Warning";
                            }

                            $("<span>")
                                .addClass("badge " + badgeClass)
                                .text(text)
                                .appendTo(container);
                        }
                    },
                    {
                        dataField: "ConnectionId",
                        caption: "Connection",
                        width: 110,
                        alignment: "center",
                        cellTemplate: function(container, options) {
                            const badgeClass = options.value ? "badge bg-success" : "badge bg-secondary";
                            const text = options.value ? "Online" : "Offline";
                            $("<span>").addClass(badgeClass).text(text).appendTo(container);
                        }
                    },
                    {
                        type: "buttons",
                        width: 120,
                        buttons: [
                            {
                                hint: "View Details",
                                icon: "info",
                                onClick: function(e) {
                                    showDetails(e.row.data);
                                }
                            },
                            {
                                hint: "Block Device",
                                icon: "clear",
                                visible: function(e) {
                                    return e.row.data.Status !== 3;
                                },
                                onClick: function(e) {
                                    showBlock(e.row.data);
                                }
                            }
                        ]
                    }
                ],
                onContentReady: function() {
                    console.log("Grid rendered with " + devices.length + " items");
                }
            }).dxDataGrid("instance");
        }, 200);
    });

    function showDetails(device) {
        pendingDetailsData = device;
        detailsPopup.option("title", "Device Details: " + device.DeviceName);
        detailsPopup.show();
    }

    function renderDetails(device) {
        const registeredDate = new Date(device.RegisteredAt).toLocaleDateString('pl-PL');
        const lastSeenDate = new Date(device.LastSeenAt).toLocaleString('pl-PL');

        let statusBadge = "bg-secondary";
        let statusText = "Unknown";
        if (device.Status === 1) {
            statusBadge = "bg-success";
            statusText = "Online";
        } else if (device.Status === 2) {
            statusBadge = "bg-warning";
            statusText = "Offline";
        } else if (device.Status === 3) {
            statusBadge = "bg-danger";
            statusText = "Blocked";
        } else if (device.Status === 4) {
            statusBadge = "bg-warning";
            statusText = "Warning";
        }

        const content = `
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="mb-3"><i class="dx-icon-runner"></i> Device Information</h6>
                        <table class="table table-sm table-borderless">
                            <tr><th width="40%">Device Name:</th><td>${device.DeviceName}</td></tr>
                            <tr><th>HWID:</th><td><code>${device.Hwid}</code></td></tr>
                            <tr><th>Status:</th><td><span class="badge ${statusBadge}">${statusText}</span></td></tr>
                            <tr><th>IP Address:</th><td>${device.LastIpAddress || 'N/A'}</td></tr>
                            <tr><th>Registered:</th><td>${registeredDate}</td></tr>
                            <tr><th>Last Seen:</th><td>${lastSeenDate}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="mb-3"><i class="dx-icon-info"></i> Connection</h6>
                        <p><strong>Status:</strong> ${device.ConnectionId ? '<span class="badge bg-success">Online</span>' : '<span class="badge bg-secondary">Offline</span>'}</p>
                        ${device.ConnectionId ? `<p><strong>Connection ID:</strong> <code>${device.ConnectionId}</code></p>` : ''}
                        <hr>
                        ${device.Status !== 3 ? `
                        <button class="btn btn-danger btn-sm" onclick="closeDetailsAndBlock(${device.Id})">
                            <i class="dx-icon-clear"></i> Block Device
                        </button>` : ''}
                    </div>
                </div>
            `;

        $("#detailsContent").html(content);
    }

    function showBlock(device) {
        pendingBlockData = device;
        blockPopup.option("title", "Block Device");
        blockPopup.show();
    }

    function renderBlock(device) {
        const content = `
                <div class="alert alert-warning">
                    <i class="dx-icon-warning"></i> <strong>Warning!</strong> This will prevent the device from accessing the application.
                </div>
                <p>Are you sure you want to block this device?</p>
                <table class="table table-sm">
                    <tr><th>Device Name:</th><td>${device.DeviceName}</td></tr>
                    <tr><th>HWID:</th><td><code>${device.Hwid}</code></td></tr>
                    <tr><th>IP Address:</th><td>${device.LastIpAddress || 'N/A'}</td></tr>
                </table>
                <div class="d-flex gap-2 mt-3">
                    <button type="button" class="btn btn-danger" onclick="confirmBlock(${device.Id})">
                        <i class="dx-icon-clear"></i> Yes, Block Device
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="blockPopup.hide()">
                        Cancel
                    </button>
                </div>
            `;

        $("#blockContent").html(content);
    }

    function closeDetailsAndBlock(deviceId) {
        detailsPopup.hide();
        const device = devices.find(d => d.Id === deviceId);
        if (device) {
            showBlock(device);
        }
    }

    function confirmBlock(deviceId) {
        DevExpress.ui.notify("Block functionality not yet implemented", "info", 2000);
        blockPopup.hide();
    }
</script>
}