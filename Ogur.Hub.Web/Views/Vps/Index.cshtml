@* File: Hub.Web/Views/Vps/Index.cshtml *@
@model VpsMonitoringViewModel
@{
    ViewData["Title"] = Model.Title;
}

<!-- Page Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2>@Model.Title</h2>
                <p class="text-muted">@Model.Description</p>
            </div>
            <div>
                <button type="button" class="btn btn-outline-secondary me-2" onclick="toggleResourceView()">
                    <i class="dx-icon-card" id="viewToggleIcon"></i> <span id="viewToggleText">Card View</span>
                </button>
                <button type="button" class="btn btn-success" onclick="showAddWebsitePopup()">
                    <i class="dx-icon-add"></i> Add Website
                </button>
                <button type="button" class="btn btn-primary" onclick="refreshAll()">
                    <i class="dx-icon-refresh"></i> Refresh All
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Resource Stats Gauge View (Default) -->
<div id="gaugeView" style="display: block;">
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="card-subtitle mb-3">CPU Usage</h6>
                    <div id="cpuGauge"></div>
                    <small id="cpuLoadGauge"
                           class="text-muted">Load: @(Model.CurrentResources?.LoadAverage1Min.ToString("F2") ?? "N/A")</small>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="card-subtitle mb-3">Memory</h6>
                    <div id="memoryGauge"></div>
                    <small id="memoryDetailsGauge"
                           class="text-muted">@(Model.CurrentResources?.MemoryUsedGb.ToString("F2") ?? "0") GB
                        / @(Model.CurrentResources?.MemoryTotalGb.ToString("F2") ?? "0") GB</small>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="card-subtitle mb-3">Disk</h6>
                    <div id="diskGauge"></div>
                    <small id="diskDetailsGauge"
                           class="text-muted">@(Model.CurrentResources?.DiskUsedGb.ToString("F2") ?? "0") GB
                        / @(Model.CurrentResources?.DiskTotalGb.ToString("F2") ?? "0") GB</small>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="card-subtitle mb-3">Network RX</h6>
                    <div id="networkGauge"></div>
                    <small id="networkTxGauge"
                           class="text-muted">TX: @(Model.CurrentResources?.NetworkTxMbps.ToString("F2") ?? "0") Mbps</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Resource Stats Cards View -->
<div id="cardsView" style="display: none;">
    @if (Model.CurrentResources != null)
    {
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stat-card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-subtitle mb-2">CPU Usage</h6>
                                <h2 class="card-title mb-0"
                                    id="cpuUsage">@Model.CurrentResources.CpuUsagePercent.ToString("F2")%</h2>
                                <small id="cpuLoad">Load: @Model.CurrentResources.LoadAverage1Min.ToString("F2")</small>
                            </div>
                            <div class="stat-icon">
                                <i class="dx-icon-runner" style="font-size: 48px;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stat-card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-subtitle mb-2">Memory</h6>
                                <h2 class="card-title mb-0"
                                    id="memoryUsage">@Model.CurrentResources.MemoryUsagePercent.ToString("F2")%</h2>
                                <small id="memoryDetails">@Model.CurrentResources.MemoryUsedGb.ToString("F2") GB
                                    / @Model.CurrentResources.MemoryTotalGb.ToString("F2") GB</small>
                            </div>
                            <div class="stat-icon">
                                <i class="dx-icon-chart" style="font-size: 48px;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stat-card bg-warning text-dark">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-subtitle mb-2">Disk</h6>
                                <h2 class="card-title mb-0"
                                    id="diskUsage">@Model.CurrentResources.DiskUsagePercent.ToString("F2")%</h2>
                                <small id="diskDetails">@Model.CurrentResources.DiskUsedGb.ToString("F2") GB
                                    / @Model.CurrentResources.DiskTotalGb.ToString("F2") GB</small>
                            </div>
                            <div class="stat-icon">
                                <i class="dx-icon-box" style="font-size: 48px;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stat-card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-subtitle mb-2">Network</h6>
                                <h2 class="card-title mb-0"
                                    id="networkRx">@Model.CurrentResources.NetworkRxMbps.ToString("F2") Mbps</h2>
                                <small
                                    id="networkTx">TX: @Model.CurrentResources.NetworkTxMbps.ToString("F2") Mbps</small>
                            </div>
                            <div class="stat-icon">
                                <i class="dx-icon-globe" style="font-size: 48px;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="row mb-4">
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="dx-icon-info"></i> Loading VPS resource data...
                </div>
            </div>
        </div>
    }
</div>

<!-- Containers Card -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Docker Containers (<span id="containersCount">@Model.Containers.Count</span>)</h5>
            </div>
            <div class="card-body p-0">
                <div id="containersGrid"></div>
            </div>
        </div>
    </div>
</div>

<!-- Websites Card -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Monitored Websites (<span id="websitesCount">@Model.Websites.Count</span>)</h5>
            </div>
            <div class="card-body p-0">
                <div id="websitesGrid"></div>
            </div>
        </div>
    </div>
</div>

<!-- Add Website Popup -->
<div id="addWebsitePopup"></div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.0/signalr.min.js"></script>
    <script type="text/javascript" src="https://code.jscharting.com/latest/jscharting.js"></script>
    <script type="text/javascript" src="https://code.jscharting.com/latest/modules/types.js"></script>

    <script>
        let containersGrid;
        let websitesGrid;

        let addWebsitePopup;
        const apiBaseUrl = '@ViewBag.ApiBaseUrl';
        const authToken = '@Context.Session.GetString("AuthToken")';

        // Helper function to convert PascalCase to camelCase
        function toCamelCase(obj) {
            if (Array.isArray(obj)) {
                return obj.map(item => toCamelCase(item));
            } else if (obj !== null && typeof obj === 'object') {
                return Object.keys(obj).reduce((result, key) => {
                    const camelKey = key.charAt(0).toLowerCase() + key.slice(1);
                    result[camelKey] = toCamelCase(obj[key]);
                    return result;
                }, {});
            }
            return obj;
        }

        const vpsData = {
            containers: toCamelCase(@Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Containers))),
            websites: toCamelCase(@Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Websites))),
            apiBaseUrl: "@Model.ApiBaseUrl"
        };

        let cpuGauge, memoryGauge, diskGauge, networkGauge;
        let isGaugeView = true;

        $(function () {
            initializeContainersGrid();
            initializeWebsitesGrid();
            initializeAddWebsitePopup();
            initializeGauges();
            setupSignalR();
        });


        function initializeGauges() {
            const colors = getGaugeColors();

            cpuGauge = JSC.chart('cpuGauge', {
                type: 'gauge',
                animation_duration: 500,
                legend_visible: false,                
                box_fill: colors.background,
                debug: false,
                xAxis: { spacingPercentage: 0.3 },
                yAxis: {
                    defaultTick: {
                        padding: 8,
                        label_style_fontSize: '16px',
                        label_color: colors.textColor
                    },
                    line: {
                        width: 8,
                        color: 'smartPalette',
                        breaks_gap: 0.00
                    },
                    scale_range: [0, 100]
                },
                palette: {
                    pointValue: '{%value/100}',
                    colors: colors.colors
                },
                defaultTooltip_enabled: false,
                defaultSeries: {
                    angle: {sweep: 180},
                    shape: {
                        innerSize: '70%',
                        label: {
                            text: '<span color="%color">{%sum:n1}</span><br/><span color="' + colors.labelColor + '" fontSize="16px">%</span>',
                            style_fontSize: '46px',
                            style_color: colors.textColor,
                            verticalAlign: 'middle'
                        }
                    }
                },
                series: [{
                    type: 'column roundcaps',
                    points: [{id: 'cpu', x: 'CPU', y: @(Model.CurrentResources?.CpuUsagePercent ?? 0)}]
                }]
            });

            // Memory Gauge
            memoryGauge = JSC.chart('memoryGauge', {
                type: 'gauge',
                animation_duration: 500,
                legend_visible: false,
                box_fill: colors.background,
                debug: false,
                xAxis: { spacingPercentage: 0.3 },
                yAxis: {
                    defaultTick: {
                        padding: 8,
                        label_style_fontSize: '16px',
                        label_color: colors.textColor
                    },
                    line: {
                        width: 10,
                        color: 'smartPalette',
                        breaks_gap: 0.00
                    },
                    scale_range: [0, 100]
                },
                palette: {
                    pointValue: '{%value/100}',
                    colors: colors.colors
                },
                defaultTooltip_enabled: false,
                defaultSeries: {
                    angle: {sweep: 180},
                    shape: {
                        innerSize: '70%',
                        label: {
                            text: '<span color="%color">{%sum:n1}</span><br/><span color="' + colors.labelColor + '" fontSize="16px">%</span>',
                            style_fontSize: '46px',
                            style_color: colors.textColor,
                            verticalAlign: 'middle'
                        }
                    }
                },
                series: [{
                    type: 'column roundcaps',
                    points: [{id: 'mem', x: 'Memory', y: @(Model.CurrentResources?.MemoryUsagePercent ?? 0)}]
                }]
            });

            // Disk Gauge
            diskGauge = JSC.chart('diskGauge', {
                type: 'gauge',
                animation_duration: 500,
                legend_visible: false,
                box_fill: colors.background,
                debug: false,
                xAxis: { spacingPercentage: 0.3 },
                yAxis: {
                    defaultTick: {
                        padding: 8,
                        label_style_fontSize: '16px',
                        label_color: colors.textColor
                    },
                    line: {
                        width: 10,
                        color: 'smartPalette',
                        breaks_gap: 0.00
                    },
                    scale_range: [0, 100]
                },
                palette: {
                    pointValue: '{%value/100}',
                    colors: colors.colors
                },
                defaultTooltip_enabled: false,
                defaultSeries: {
                    angle: {sweep: 180},
                    shape: {
                        innerSize: '70%',
                        label: {
                            text: '<span color="%color">{%sum:n1}</span><br/><span color="' + colors.labelColor + '" fontSize="16px">%</span>',
                            style_fontSize: '46px',
                            style_color: colors.textColor,
                            verticalAlign: 'middle'
                        }
                    }
                },
                series: [{
                    type: 'column roundcaps',
                    points: [{id: 'disk', x: 'Disk', y: @(Model.CurrentResources?.DiskUsagePercent ?? 0)}]
                }]
            });

            // Network Gauge (dynamic scale)
            networkGauge = JSC.chart('networkGauge', {
                type: 'gauge',
                animation_duration: 500,
                legend_visible: false,
                box_fill: colors.background,
                debug: false,
                xAxis: { spacingPercentage: 0.3 },
                yAxis: {
                    defaultTick: {
                        padding: 8,
                        label_style_fontSize: '16px',
                        label_color: colors.textColor
                    },
                    line: {
                        width: 10,
                        color: 'smartPalette',
                        breaks_gap: 0.00
                    },
                    scale_range: [0, 100]
                },
                palette: {
                    pointValue: '{%value/100}',
                    colors: colors.colors
                },
                defaultTooltip_enabled: false,
                defaultSeries: {
                    angle: {sweep: 180},
                    shape: {
                        innerSize: '70%',
                        label: {
                            text: '<span color="%color">{%sum:n1}</span><br/><span color="' + colors.labelColor + '" fontSize="16px">%</span>',
                            style_fontSize: '46px',
                            style_color: colors.textColor,
                            verticalAlign: 'middle'
                        }
                    }
                },
                series: [{
                    type: 'column roundcaps',
                    points: [{id: 'net', x: 'Network', y: @(Model.CurrentResources?.NetworkRxMbps ?? 0)}]
                }]
            });
        }

        function updateGauges(resources) {
            const cpuUsage = resources.cpuUsagePercent ?? resources.CpuUsagePercent ?? 0;
            const memoryUsage = resources.memoryUsagePercent ?? resources.MemoryUsagePercent ?? 0;
            const diskUsage = resources.diskUsagePercent ?? resources.DiskUsagePercent ?? 0;
            const networkRx = resources.networkRxMbps ?? resources.NetworkRxMbps ?? 0;
            const loadAvg = resources.loadAverage1Min ?? resources.LoadAverage1Min ?? 0;
            const memoryUsed = resources.memoryUsedGb ?? resources.MemoryUsedGb ?? 0;
            const memoryTotal = resources.memoryTotalGb ?? resources.MemoryTotalGb ?? 0;
            const diskUsed = resources.diskUsedGb ?? resources.DiskUsedGb ?? 0;
            const diskTotal = resources.diskTotalGb ?? resources.DiskTotalGb ?? 0;
            const networkTx = resources.networkTxMbps ?? resources.NetworkTxMbps ?? 0;

            console.log("Updating gauges:", cpuUsage, memoryUsage, diskUsage, networkRx);

            // Update gauge values
            if (cpuGauge && cpuGauge.series) {
                cpuGauge.series(0).points([{id: 'cpu', x: 'CPU', y: cpuUsage}]);
            }
            if (memoryGauge && memoryGauge.series) {
                memoryGauge.series(0).points([{id: 'mem', x: 'Memory', y: memoryUsage}]);
            }
            if (diskGauge && diskGauge.series) {
                diskGauge.series(0).points([{id: 'disk', x: 'Disk', y: diskUsage}]);
            }
            if (networkGauge && networkGauge.series) {
                networkGauge.series(0).points([{id: 'net', x: 'Network', y: networkRx}]);
            }

            // Update text details
            $("#cpuLoadGauge").text(`Load: ${loadAvg.toFixed(2)}`);
            $("#memoryDetailsGauge").text(`${memoryUsed.toFixed(2)} GB / ${memoryTotal.toFixed(2)} GB`);
            $("#diskDetailsGauge").text(`${diskUsed.toFixed(2)} GB / ${diskTotal.toFixed(2)} GB`);
            $("#networkTxGauge").text(`TX: ${networkTx.toFixed(2)} Mbps`);
        }

        function getGaugeColors() {
            const isDark = document.documentElement.classList.contains('dark-mode') ||
                document.documentElement.getAttribute('data-bs-theme') === 'dark';
            
            const cardBg = getComputedStyle(document.documentElement).getPropertyValue('--card-bg').trim();

            const finalBg = cardBg || (isDark ? '#2d2d2d' : '#ffffff');

            return {
                background: finalBg,
                textColor: isDark ? '#e0e0e0' : '#212529',
                labelColor: isDark ? '#999999' : '#6c757d',
                colors: isDark
                    ? ['#4caf50', '#ff9800', '#f44336']
                    : ['#92d050', '#ffc000', '#ff0000']
            };
        }
        
        function toggleResourceView() {
            isGaugeView = !isGaugeView;

            if (isGaugeView) {
                $("#cardsView").hide();
                $("#gaugeView").show();
                $("#viewToggleText").text("Card View");
                $("#viewToggleIcon").removeClass("dx-icon-chart").addClass("dx-icon-card");
            } else {
                $("#cardsView").show();
                $("#gaugeView").hide();
                $("#viewToggleText").text("Gauge View");
                $("#viewToggleIcon").removeClass("dx-icon-card").addClass("dx-icon-chart");
            }
        }

        function initializeContainersGrid() {

            containersGrid = $("#containersGrid").dxDataGrid({
                dataSource: vpsData.containers,
                height: 400,
                showBorders: true,
                showRowLines: true,
                rowAlternationEnabled: true,
                columnAutoWidth: true,
                allowColumnReordering: true,
                allowColumnResizing: true,
                columnResizingMode: "widget",
                noDataText: "No containers found",
                scrolling: {
                    mode: "virtual"
                },
                columns: [
                    {dataField: "name", caption: "Name", width: 200},
                    {dataField: "image", caption: "Image", width: 250},
                    {dataField: "state", caption: "State", width: 100},
                    {dataField: "status", caption: "Status", width: 150},
                    {
                        dataField: "cpuUsagePercent",
                        caption: "CPU %",
                        width: 100,
                        format: {type: "fixedPoint", precision: 2}
                    },
                    {
                        dataField: "memoryUsagePercent",
                        caption: "Memory %",
                        width: 100,
                        format: {type: "fixedPoint", precision: 2}
                    },
                    {
                        dataField: "memoryUsageMb",
                        caption: "Memory (MB)",
                        width: 120,
                        format: {type: "fixedPoint", precision: 2}
                    },
                    {
                        dataField: "lastUpdatedAt",
                        caption: "Last Updated",
                        dataType: "datetime",
                        format: "dd/MM/yyyy HH:mm:ss",
                        width: 180
                    }
                ],
                paging: {pageSize: 20},
                searchPanel: {visible: true},
                filterRow: {visible: true}
            }).dxDataGrid("instance");
        }

        function initializeWebsitesGrid() {

            websitesGrid = $("#websitesGrid").dxDataGrid({
                dataSource: vpsData.websites,
                height: 400,
                showBorders: true,
                showRowLines: true,
                rowAlternationEnabled: true,
                columnAutoWidth: true,
                allowColumnReordering: true,
                allowColumnResizing: true,
                columnResizingMode: "widget",
                noDataText: "No websites found",
                scrolling: {
                    mode: "virtual"
                },
                columns: [
                    {dataField: "domain", caption: "Domain", width: 250},
                    {dataField: "serviceName", caption: "Service", width: 150},
                    {dataField: "containerName", caption: "Container", width: 150},
                    {
                        dataField: "lastStatusCode",
                        caption: "HTTP Code",
                        width: 100,
                        alignment: "center"
                    },
                    {
                        name: "statusBadge",
                        caption: "Status",
                        width: 120,
                        alignment: "center",
                        calculateCellValue: function (rowData) {
                            return rowData.lastStatusCode;
                        },
                        cellTemplate: function (container, options) {
                            const statusCode = options.value;
                            let badgeClass = "bg-secondary";
                            let text = "N/A";

                            if (!statusCode) {
                                badgeClass = "bg-secondary";
                                text = "N/A";
                            } else if (statusCode >= 200 && statusCode < 300) {
                                badgeClass = "bg-success";
                                text = "Active";
                            } else if (statusCode >= 300 && statusCode < 400) {
                                badgeClass = "bg-info";
                                text = `Redirect (${statusCode})`;
                            } else if (statusCode >= 400 && statusCode < 500) {
                                badgeClass = "bg-warning";
                                text = `Valid (${statusCode})`;
                            } else if (statusCode >= 500) {
                                badgeClass = "bg-danger";
                                text = `Error (${statusCode})`;
                            }

                            $("<span>")
                                .addClass("badge " + badgeClass)
                                .text(text)
                                .appendTo(container);
                        }
                    },
                    {
                        dataField: "sslEnabled",
                        caption: "SSL",
                        width: 80,
                        cellTemplate: function (container, options) {
                            const ssl = options.value ?
                                '<span class="badge bg-success">Yes</span>' :
                                '<span class="badge bg-secondary">No</span>';
                            container.append(ssl);
                        }
                    },
                    {
                        dataField: "lastResponseTimeMs",
                        caption: "Response (ms)",
                        width: 130
                    },
                    {
                        dataField: "lastCheckedAt",
                        caption: "Last Checked",
                        dataType: "datetime",
                        format: "dd/MM/yyyy HH:mm:ss",
                        width: 180
                    },
                    {
                        type: "buttons",
                        width: 80,
                        buttons: [{
                            hint: "Delete",
                            icon: "trash",
                            onClick: function (e) {
                                deleteWebsite(e.row.data.id, e.row.data.domain);
                            }
                        }]
                    }
                ],
                paging: {pageSize: 20},
                searchPanel: {visible: true},
                filterRow: {visible: true}
            }).dxDataGrid("instance");

        }

        function initializeAddWebsitePopup() {
            addWebsitePopup = $("#addWebsitePopup").dxPopup({
                title: "Add Website",
                width: 500,
                height: "auto",
                contentTemplate: function (contentElement) {
                    const form = $("<div>").dxForm({
                        formData: {
                            domain: "",
                            serviceName: "",
                            sslEnabled: true
                        },
                        items: [
                            {
                                dataField: "domain",
                                label: {text: "Domain"},
                                editorOptions: {
                                    placeholder: "example.com"
                                },
                                validationRules: [{type: "required", message: "Domain is required"}]
                            },
                            {
                                dataField: "serviceName",
                                label: {text: "Service Name"},
                                editorOptions: {
                                    placeholder: "My Service"
                                },
                                validationRules: [{type: "required", message: "Service name is required"}]
                            },
                            {
                                dataField: "sslEnabled",
                                editorType: "dxCheckBox",
                                label: {text: "SSL Enabled (HTTPS)"}
                            }
                        ]
                    }).appendTo(contentElement);

                    const buttonContainer = $("<div>").addClass("text-end mt-3").appendTo(contentElement);

                    $("<div>").dxButton({
                        text: "Add Website",
                        type: "success",
                        onClick: function () {
                            const formInstance = form.dxForm("instance");
                            if (!formInstance.validate().isValid) return;

                            const data = formInstance.option("formData");
                            submitAddWebsite(data);
                        }
                    }).appendTo(buttonContainer);

                    $("<div>").dxButton({
                        text: "Cancel",
                        onClick: function () {
                            addWebsitePopup.hide();
                        }
                    }).addClass("ms-2").appendTo(buttonContainer);
                }
            }).dxPopup("instance");
        }

        function showAddWebsitePopup() {
            addWebsitePopup.show();
        }

        function submitAddWebsite(data) {
            $.ajax({
                url: vpsData.apiBaseUrl + '/api/vps/websites',
                method: 'POST',
                contentType: 'application/json',
                headers: {
                    'Authorization': 'Bearer ' + '@ViewBag.JwtToken'
                },
                data: JSON.stringify(data),
                success: function (result) {
                    DevExpress.ui.notify("Website added successfully!", "success", 2000);
                    addWebsitePopup.hide();
                    location.reload();

                    $.ajax({
                        url: vpsData.apiBaseUrl + '/api/vps/websites',
                        method: 'GET',
                        headers: {
                            'Authorization': 'Bearer ' + '@ViewBag.JwtToken'
                        },
                        success: function (websites) {
                            websitesGrid.option("dataSource", websites);
                            $("#websitesCount").text(websites.length);
                        }
                    });
                },
                error: function (xhr) {
                    var message = xhr.responseJSON?.message || "Failed to add website";
                    DevExpress.ui.notify(message, "error", 3000);
                }
            });
        }

        function deleteWebsite(id, domain) {
            DevExpress.ui.dialog.confirm("Are you sure you want to delete website: " + domain + "?", "Confirm Delete")
                .then(function (confirmed) {
                    if (confirmed) {
                        $.ajax({
                            url: vpsData.apiBaseUrl + '/api/vps/websites/' + id,
                            method: 'DELETE',
                            headers: {
                                'Authorization': 'Bearer ' + '@ViewBag.JwtToken'
                            },
                            success: function () {
                                DevExpress.ui.notify("Website deleted successfully!", "success", 2000);

                                $.ajax({
                                    url: vpsData.apiBaseUrl + '/api/vps/websites',
                                    method: 'GET',
                                    headers: {
                                        'Authorization': 'Bearer ' + '@ViewBag.JwtToken'
                                    },
                                    success: function (websites) {
                                        websitesGrid.option("dataSource", websites);
                                        $("#websitesCount").text(websites.length);
                                    }
                                });
                            },
                            error: function () {
                                DevExpress.ui.notify("Failed to delete website", "error", 2000);
                            }
                        });
                    }
                });
        }

        function setupSignalR() {
            const connection = new signalR.HubConnectionBuilder()
                .withUrl(vpsData.apiBaseUrl + "/hubs/vps")
                .withAutomaticReconnect()
                .build();

            connection.on("VpsStatsUpdated", function (data) {

                // Handle both camelCase and PascalCase
                const containers = data.Containers || data.containers;
                const websites = data.Websites || data.websites;
                const resources = data.Resources || data.resources;

                if (containers && Array.isArray(containers) && containers.length > 0) {
                    containersGrid.option("dataSource", containers);
                    containersGrid.refresh();
                    $("#containersCount").text(containers.length);
                } else {
                    console.log("No containers data");
                }

                if (websites && Array.isArray(websites)) {
                    websitesGrid.beginUpdate();
                    websitesGrid.option("dataSource", websites);
                    websitesGrid.endUpdate();
                    $("#websitesCount").text(websites.length);
                } else {
                    console.log("No websites data");
                }

                if (resources) {
                    console.log("Updating resources");
                    updateResourceCards(resources);
                } else {
                    console.log("No resources data");
                }


            });

            connection.onreconnecting(() => {
                console.log("VPS monitoring reconnecting...");
            });

            connection.onreconnected(() => {
                console.log("VPS monitoring reconnected");
                connection.invoke("JoinMonitoring").catch(err => console.error("JoinMonitoring error:", err));
            });

            connection.start()
                .then(() => {
                    console.log("VPS monitoring SignalR connected");
                    return connection.invoke("JoinMonitoring");
                })
                .then(() => {
                    console.log("Joined VPS monitoring group");
                })
                .catch(err => console.error("VPS monitoring connection error:", err));
        }

        function updateResourceCards(resources) {
            if (!resources) {
                console.error("No resources data!");
                return;
            }

            const cpuUsage = resources.cpuUsagePercent ?? resources.CpuUsagePercent ?? 0;
            const memoryUsage = resources.memoryUsagePercent ?? resources.MemoryUsagePercent ?? 0;
            const memoryUsed = resources.memoryUsedGb ?? resources.MemoryUsedGb ?? 0;
            const memoryTotal = resources.memoryTotalGb ?? resources.MemoryTotalGb ?? 0;
            const diskUsage = resources.diskUsagePercent ?? resources.DiskUsagePercent ?? 0;
            const diskUsed = resources.diskUsedGb ?? resources.DiskUsedGb ?? 0;
            const diskTotal = resources.diskTotalGb ?? resources.DiskTotalGb ?? 0;
            const networkRx = resources.networkRxMbps ?? resources.NetworkRxMbps ?? 0;
            const networkTx = resources.networkTxMbps ?? resources.NetworkTxMbps ?? 0;
            const loadAvg = resources.loadAverage1Min ?? resources.LoadAverage1Min ?? 0;

            console.log("Updating resources:", cpuUsage, memoryUsage, diskUsage, networkRx);

            // Update card view
            $("#cpuUsage").text(cpuUsage.toFixed(2) + "%");
            $("#cpuLoad").text("Load: " + loadAvg.toFixed(2));
            $("#memoryUsage").text(memoryUsage.toFixed(2) + "%");
            $("#memoryDetails").text(memoryUsed.toFixed(2) + " GB / " + memoryTotal.toFixed(2) + " GB");
            $("#diskUsage").text(diskUsage.toFixed(2) + "%");
            $("#diskDetails").text(diskUsed.toFixed(2) + " GB / " + diskTotal.toFixed(2) + " GB");
            $("#networkRx").text(networkRx.toFixed(2) + " Mbps");
            $("#networkTx").text("TX: " + networkTx.toFixed(2) + " Mbps");

            // Update JSCharting gauges
            if (cpuGauge && cpuGauge.series) {
                cpuGauge.series(0).options({
                    points: [{id: 'cpu', x: 'CPU', y: cpuUsage}]
                });
            }

            if (memoryGauge && memoryGauge.series) {
                memoryGauge.series(0).options({
                    points: [{id: 'mem', x: 'Memory', y: memoryUsage}]
                });
            }

            if (diskGauge && diskGauge.series) {
                diskGauge.series(0).options({
                    points: [{id: 'disk', x: 'Disk', y: diskUsage}]
                });
            }

            if (networkGauge && networkGauge.series) {
                networkGauge.series(0).options({
                    points: [{id: 'net', x: 'Network', y: networkRx}]
                });
            }

            // Update text details below gauges
            $("#cpuLoadGauge").text("Load: " + loadAvg.toFixed(2));
            $("#memoryDetailsGauge").text(memoryUsed.toFixed(2) + " GB / " + memoryTotal.toFixed(2) + " GB");
            $("#diskDetailsGauge").text(diskUsed.toFixed(2) + " GB / " + diskTotal.toFixed(2) + " GB");
            $("#networkTxGauge").text("TX: " + networkTx.toFixed(2) + " Mbps");
        }

        function refreshAll() {
            DevExpress.ui.notify("Refreshing all data...", "info", 1000);

            $.ajax({
                url: apiBaseUrl + '/api/vps/containers/refresh',
                method: 'POST',
                headers: {'Authorization': 'Bearer ' + authToken}
            })
                .then(() => {
                    return $.ajax({
                        url: apiBaseUrl + '/api/vps/websites/refresh',
                        method: 'POST',
                        headers: {'Authorization': 'Bearer ' + authToken}
                    });
                })
                .then(() => {
                    DevExpress.ui.notify("All data refreshed successfully!", "success", 2000);
                    location.reload(); // Odśwież stronę żeby pokazać nowe dane
                })
                .fail((xhr) => {
                    console.error("Refresh failed:", xhr);
                    const msg = xhr.responseJSON?.message || "Error refreshing data";
                    DevExpress.ui.notify(msg, "error", 3000);
                });
        }
    </script>
}
